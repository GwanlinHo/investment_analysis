<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綜合投資分析報告 | {{ date_str }}</title>
    <!-- 
    HIDDEN DATA FOR AI ANALYSIS
    AI Agents should read these blocks to perform analysis.
    -->
    <script id="fundamental-data" type="application/json">
    {{ fundamental_json | safe }}
    </script>
    <script id="yield-data" type="application/json">
    {{ yield_json | safe }}
    </script>
    <script id="market-data" type="application/json">
    {{ market_json | safe }}
    </script>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --text-primary: #333;
            --text-secondary: #666;
            --card-bg: #ffffff;
            --up-color: #e53935;
            --down-color: #43a047;
            --accent-color: #1a237e;
            --border-color: #e0e0e0;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-primary); line-height: 1.6; }
        
        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { text-align: center; margin-bottom: 30px; padding: 20px 0; }
        h1 { margin: 0; color: var(--accent-color); font-size: 28px; font-weight: 700; letter-spacing: 1px; }
        .date-tag { display: inline-block; background: #e8eaf6; color: var(--accent-color); padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; font-weight: 500; }

        /* Market Summary Bar */
        .summary-bar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 40px; }
        .summary-card { background: var(--card-bg); padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 3px solid transparent; }
        .summary-title { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 3px; }
        .summary-price { font-size: 16px; font-weight: 800; color: var(--text-primary); }
        .summary-change { font-size: 12px; font-weight: 600; margin-top: 2px; }

        /* Common Utils */
        .text-up { color: var(--up-color); }
        .text-down { color: var(--down-color); }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px; margin-bottom: 25px; overflow: hidden; }
        
        /* Group Section */
        .group-section { margin-bottom: 50px; }
        .group-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; border-bottom: 2px solid #eceff1; padding-bottom: 8px; flex-wrap: wrap; gap: 10px; }
        .group-title { font-size: 22px; color: #2c3e50; border-left: 5px solid var(--accent-color); padding-left: 15px; margin: 0; font-weight: 700; }
        .market-status { font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 4px; display: flex; align-items: center; gap: 6px; }
        .status-closed { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-open { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        .subsection-title { text-align: center; font-size: 18px; color: var(--text-secondary); margin: 30px 0 20px; position: relative; }
        .subsection-title:after { content: ''; display: block; width: 50px; height: 3px; background: #ddd; margin: 10px auto 0; }

        /* Table Styles */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th { background-color: #f8f9fa; color: #495057; font-weight: 600; padding: 8px 4px; text-align: right; border-bottom: 2px solid var(--border-color); }
        th:first-child { text-align: left; }
        th:nth-child(4) { text-align: center; width: 70px; }
        td { padding: 8px 4px; border-bottom: 1px solid var(--border-color); text-align: right; }
        td:first-child { text-align: left; font-weight: 600; color: var(--accent-color); }
        tr:hover { background-color: #f1f3f5; }
        
        /* Badges */
        .badge { padding: 4px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; display: inline-block; min-width: 64px; text-align: center; }
        .bullish-strong { background-color: #e53935; }
        .bullish-weak { background-color: #ef9a9a; color: #b71c1c; }
        .bearish-strong { background-color: #43a047; }
        .bearish-weak { background-color: #a5d6a7; color: #1b5e20; }
        .neutral { background-color: #9e9e9e; }
        .trend-cell { text-align: center; }

        /* Navigation */
        html { scroll-behavior: smooth; }
        .nav-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-btn { background: #fff; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 6px 14px; border-radius: 20px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .nav-btn:hover { background: var(--accent-color); color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .back-to-top { position: fixed; bottom: 30px; right: 30px; background: var(--accent-color); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.25); transition: transform 0.2s; z-index: 1000; font-size: 20px; opacity: 0.9; }
        .back-to-top:hover { transform: scale(1.1); opacity: 1; }

        /* Charts Grid */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .chart-card { padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .chart-header { width: 100%; text-align: left; font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        img { max-width: 100%; height: auto; }

        /* AI Content Sections */
        #weekly-news-focus, #ai-analysis-report { margin-top: 40px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        #weekly-news-focus h2, #ai-analysis-report h2 { color: var(--accent-color); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 25px; font-size: 24px; font-weight: 700; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .summary-bar { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header id="top">
            <h1>綜合投資分析報告</h1>
            <div class="date-tag">{{ date_str }}</div>
        </header>

        <div class="nav-bar">
            <a href="#us-stocks" class="nav-btn">美股</a>
            <a href="#tw-stocks" class="nav-btn">台股</a>
            <a href="#bonds" class="nav-btn">債券</a>
            <a href="#macro-analysis" class="nav-btn">總經資訊</a>
            <a href="#weekly-news-focus" class="nav-btn">財經焦點</a>
            <a href="#ai-analysis-report" class="nav-btn">AI分析</a>
        </div>

        <div class="summary-bar">
            {{ summary_html | safe }}
        </div>

        {% for group in report_data %}
        <div id="{{ group.section_id }}" class="group-section">
            <div class="group-header">
                <h2 class="group-title">{{ group.title }}</h2>
                {% if group.is_closed %}
                <div class="market-status status-closed">
                    <span>休市中 (Market Closed)</span>
                    <span style="font-weight: normal; margin-left: 8px;">最後交易：{{ group.last_trading_date }}</span>
                </div>
                {% else %}
                <div class="market-status status-open">
                    <span>交易中 (Market Open)</span>
                    <span style="font-weight: normal; margin-left: 8px;">截至：{{ group.last_trading_date }}</span>
                </div>
                {% endif %}
            </div>
            <div class="card table-card">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>名稱</th>
                                <th>價格</th>
                                <th>漲跌%</th>
                                <th>技術訊號</th>
                                <th>量比%</th>
                                <th>K{{ kd_window }}</th>
                                <th>D{{ kd_window }}</th>
                                {% for period in bias_periods %}
                                <th>{{ period }}日乖離</th>
                                {% endfor %}
                                <th>ADX</th>
                                <th>+DI</th>
                                <th>-DI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{ group.table_rows | safe }}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <h3 class="subsection-title">K線圖概覽</h3>
            <div class="charts-grid">
                {% for symbol, b64_plot in group.plots.items() %}
                <div class="card chart-card">
                    <div class="chart-header">{{ symbol }}</div>
                    <img src="data:image/png;base64,{{ b64_plot }}" alt="{{ symbol }} Plot" loading="lazy">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        {% if yield_curve_plot_b64 %}
        <div id="macro-analysis" class="group-section">
            <h2 class="group-title">總體經濟指標</h2>
            <div class="card chart-card" style="max-width: 900px; margin: 0 auto;">
                 <div class="chart-header">美國長短期國庫券殖利率</div>
                 <img src="data:image/png;base64,{{ yield_curve_plot_b64 }}" alt="Yield Curve Plot">
                 <div style="text-align: center; margin-top: 10px; color: #555; font-size: 14px; font-weight: bold;">
                    {% if yield_data %}
                    Latest Yields: 3M: {{ "%.2f"|format(yield_data.get('3M', 0)) }}%, 
                    10Y: {{ "%.2f"|format(yield_data.get('10Y', 0)) }}%, 
                    30Y: {{ "%.2f"|format(yield_data.get('30Y', 0)) }}%
                    {% endif %}
                 </div>
            </div>
            
            <div class="card" style="margin-top: 25px; padding: 20px;">
                <h3 class="subsection-title" style="margin-top: 0; margin-bottom: 20px;">美台重要經濟指標</h3>
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px; border-left: 4px solid #1a237e; padding-left: 10px;"> 美國經濟指標</h4>
                    <div class="table-responsive"><div id="us-macro-placeholder"></div></div>
                </div>
                <div>
                    <h4 style="color: #333; margin-bottom: 15px; border-left: 4px solid #2e7d32; padding-left: 10px;"> 台灣經濟指標</h4>
                    <div class="table-responsive"><div id="tw-macro-placeholder"></div></div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="weekly-news-focus"></div>
        <div id="ai-analysis-report"></div>

        <footer style="text-align: center; margin-top: 50px; padding: 20px; color: #777; font-size: 12px; border-top: 1px solid #eee;">
            <p>[Warning] 免責聲明：本報告僅供研究參考，不構成任何投資建議。內容由 AI 自動收集與整理，可能包含錯誤或過時資訊，建議投資人與官方數據或其他來源交叉驗證。</p>
            <p>&copy; 2026 Investment Analysis Automation. Generated by AI.</p>
        </footer>
        <a href="#top" class="back-to-top" title="回到頁首">↑</a>
    </div>
</body>
</html>
